<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport"
    content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>Spacer Calculator</title>
  <meta name="description" content="Even spacer calculator for carpentry — imperial fractions">
  <meta name="theme-color" content="#0f0e0c">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Spacer Calc">
  <link rel="manifest" href="./manifest.json">
  <link rel="apple-touch-icon" href="./icon-192.png">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Bebas+Neue&display=swap"
    rel="stylesheet">
  <style>
    *,
    *::before,
    *::after {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    :root {
      --bg: #0f0e0c;
      --surface: #1a1815;
      --card: #221f1b;
      --border: #3a342a;
      --amber: #e8a022;
      --amber-dim: #a06a10;
      --amber-glow: #e8a02230;
      --cream: #f0e6d0;
      --muted: #7a6e5e;
      --green: #5a9e5a;
      --red: #b04040;
      --mono: 'Space Mono', monospace;
      --display: 'Bebas Neue', sans-serif;
    }

    html,
    body {
      min-height: 100%;
      width: 100%;
      background: var(--bg);
      color: var(--cream);
      font-family: var(--mono);
      overflow-x: hidden;
    }

    body {
      display: flex;
      justify-content: center;
      padding: 0;
    }

    .page {
      width: 100%;
      max-width: 440px;
      min-height: 100vh;
      padding: 28px 20px 48px;
      padding-left: max(20px, env(safe-area-inset-left));
      padding-right: max(20px, env(safe-area-inset-right));
      padding-bottom: max(48px, env(safe-area-inset-bottom));
      display: flex;
      flex-direction: column;
      gap: 0;
    }

    /* ── HEADER ── */
    .header {
      display: flex;
      flex-direction: column;
      gap: 2px;
      margin-bottom: 28px;
      padding-bottom: 20px;
      border-bottom: 1px solid var(--border);
      position: relative;
    }

    .header::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      width: 48px;
      height: 2px;
      background: var(--amber);
    }

    .header-eyebrow {
      font-size: 10px;
      letter-spacing: 4px;
      color: var(--amber);
      text-transform: uppercase;
    }

    .header-title {
      font-family: var(--display);
      font-size: clamp(36px, 10vw, 52px);
      letter-spacing: 2px;
      color: var(--cream);
      line-height: 1;
    }

    .header-sub {
      font-size: 10px;
      color: var(--muted);
      letter-spacing: 1px;
      margin-top: 4px;
    }

    /* ── FIELDS ── */
    .field-group {
      display: flex;
      flex-direction: column;
      gap: 16px;
      margin-bottom: 20px;
    }

    .field {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .field-label {
      font-size: 10px;
      letter-spacing: 2px;
      color: var(--amber);
      text-transform: uppercase;
    }

    .field-input {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 0;
      color: var(--cream);
      font-family: var(--mono);
      font-size: 18px;
      padding: 12px 14px;
      width: 100%;
      outline: none;
      transition: border-color 0.15s, box-shadow 0.15s;
      -webkit-appearance: none;
      appearance: none;
    }

    .field-input::placeholder {
      color: var(--muted);
      font-size: 14px;
    }

    .field-input:focus {
      border-color: var(--amber);
      box-shadow: 0 0 0 2px var(--amber-glow);
    }

    /* Remove number spinners */
    input[type=number]::-webkit-inner-spin-button,
    input[type=number]::-webkit-outer-spin-button {
      -webkit-appearance: none;
    }

    input[type=number] {
      appearance: textfield;
      -moz-appearance: textfield;
    }

    /* ── COUNTER ── */
    .counter-row {
      display: flex;
      align-items: center;
      gap: 0;
      background: var(--surface);
      border: 1px solid var(--border);
    }

    .counter-btn {
      background: none;
      border: none;
      color: var(--amber);
      font-size: 22px;
      font-family: var(--mono);
      width: 52px;
      height: 52px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.12s;
      flex-shrink: 0;
      border-right: 1px solid var(--border);
      border-left: 1px solid var(--border);
      padding: 0;
      line-height: 1;
      -webkit-tap-highlight-color: transparent;
    }

    .counter-btn:first-child {
      border-left: none;
    }

    .counter-btn:last-child {
      border-right: none;
    }

    .counter-btn:active {
      background: var(--amber-glow);
    }

    .counter-val {
      flex: 1;
      text-align: center;
      font-family: var(--mono);
      font-size: 22px;
      color: var(--cream);
      background: transparent;
      border: none;
      outline: none;
      padding: 0;
      height: 52px;
      -webkit-appearance: none;
      appearance: none;
    }

    /* ── TOGGLE ── */
    .toggle-field {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 14px 0;
      border-top: 1px solid var(--border);
      border-bottom: 1px solid var(--border);
    }

    .toggle-label-text {
      font-size: 10px;
      letter-spacing: 2px;
      color: var(--amber);
      text-transform: uppercase;
    }

    .toggle-desc {
      font-size: 11px;
      color: var(--muted);
      margin-top: 2px;
    }

    .switch {
      position: relative;
      width: 48px;
      height: 26px;
      flex-shrink: 0;
    }

    .switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .slider {
      position: absolute;
      inset: 0;
      background: var(--border);
      cursor: pointer;
      transition: background 0.2s;
      border-radius: 2px;
    }

    .slider::before {
      content: '';
      position: absolute;
      width: 20px;
      height: 20px;
      left: 3px;
      top: 3px;
      background: var(--muted);
      transition: transform 0.2s, background 0.2s;
      border-radius: 1px;
    }

    .switch input:checked+.slider {
      background: var(--amber-dim);
    }

    .switch input:checked+.slider::before {
      transform: translateX(22px);
      background: var(--amber);
    }

    /* ── SELECT ── */
    .field-select {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 0;
      color: var(--cream);
      font-family: var(--mono);
      font-size: 14px;
      padding: 12px 14px;
      width: 100%;
      outline: none;
      -webkit-appearance: none;
      appearance: none;
      cursor: pointer;
      transition: border-color 0.15s;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='7' viewBox='0 0 12 7'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%23e8a022' stroke-width='1.5' fill='none'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 14px center;
      padding-right: 36px;
    }

    .field-select:focus {
      border-color: var(--amber);
    }

    .field-select option {
      background: var(--surface);
    }

    /* ── CALCULATE BUTTON ── */
    .calc-btn {
      margin-top: 24px;
      width: 100%;
      background: var(--amber);
      color: var(--bg);
      border: none;
      font-family: var(--display);
      font-size: 22px;
      letter-spacing: 3px;
      padding: 16px;
      cursor: pointer;
      transition: opacity 0.15s, transform 0.1s;
      -webkit-tap-highlight-color: transparent;
    }

    .calc-btn:active {
      opacity: 0.85;
      transform: scale(0.99);
    }

    /* ── DIVIDER ── */
    .divider {
      height: 1px;
      background: var(--border);
      margin: 28px 0;
      position: relative;
    }

    .divider::before {
      content: 'RESULT';
      position: absolute;
      left: 0;
      top: -8px;
      font-size: 9px;
      letter-spacing: 4px;
      color: var(--muted);
      background: var(--bg);
      padding-right: 8px;
    }

    /* ── RESULT CARDS ── */
    .result-hidden {
      display: none;
    }

    .result-highlight {
      background: var(--card);
      border: 1px solid var(--amber);
      padding: 12px 16px;
      margin-bottom: 16px;
      position: relative;
      overflow: hidden;
      text-align: center;
    }

    .result-highlight::before {
      content: '';
      position: absolute;
      inset: 0;
      background: var(--amber-glow);
      pointer-events: none;
    }

    .result-highlight-label {
      font-size: 10px;
      letter-spacing: 3px;
      color: var(--amber);
      text-transform: uppercase;
      margin-bottom: 4px;
    }

    .result-highlight-value {
      font-family: var(--display);
      font-size: clamp(24px, 7vw, 32px);
      letter-spacing: 2px;
      color: var(--cream);
      line-height: 1;
    }

    .result-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-bottom: 16px;
    }

    .result-tile {
      background: var(--card);
      border: 1px solid var(--border);
      padding: 14px;
    }

    .result-tile-label {
      font-size: 9px;
      letter-spacing: 2px;
      color: var(--muted);
      text-transform: uppercase;
      margin-bottom: 4px;
    }

    .result-tile-value {
      font-size: 16px;
      color: var(--cream);
      font-weight: 700;
    }

    .error-box {
      background: var(--card);
      border: 1px solid var(--red);
      padding: 16px;
      color: #e08080;
      font-size: 12px;
      letter-spacing: 1px;
    }

    /* ── VISUALIZATION ── */
    .viz-section {
      margin-bottom: 20px;
    }

    .viz-label {
      font-size: 9px;
      letter-spacing: 3px;
      color: var(--muted);
      text-transform: uppercase;
      margin-bottom: 10px;
    }

    .viz-track {
      width: 100%;
      height: 40px;
      display: flex;
      align-items: stretch;
      background: var(--surface);
      border: 1px solid var(--border);
      overflow: hidden;
    }

    .viz-spacer {
      background: var(--amber);
      opacity: 0.9;
      flex-shrink: 0;
    }

    .viz-space {
      background: var(--bg);
      outline: 1px dashed var(--border);
      outline-offset: -1px;
      flex-shrink: 0;
    }

    /* ── TABLE ── */
    .table-section {
      margin-bottom: 32px;
    }

    .table-label {
      font-size: 9px;
      letter-spacing: 3px;
      color: var(--muted);
      text-transform: uppercase;
      margin-bottom: 10px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
    }

    th {
      font-size: 9px;
      letter-spacing: 2px;
      color: var(--muted);
      text-transform: uppercase;
      border-bottom: 1px solid var(--border);
      padding: 8px 6px;
      text-align: center;
      font-weight: 400;
    }

    td {
      padding: 8px 6px;
      text-align: center;
      border-bottom: 1px solid #1e1c19;
      color: var(--cream);
    }

    tr:nth-child(even) td {
      background: var(--surface);
    }

    td:first-child {
      color: var(--amber);
      font-weight: 700;
    }

    /* ── CUSTOM KEYBOARD ── */
    .kb-overlay {
      display: none;
      position: fixed;
      inset: 0;
      z-index: 10;
    }

    .kb-overlay.open {
      display: block;
    }

    .kb-panel {
      position: fixed;
      background: #141210;
      border: 1px solid var(--amber);
      z-index: 11;
      box-shadow: 0 8px 28px rgba(0, 0, 0, 0.7);
      opacity: 0;
      pointer-events: none;
      transform: translateY(-6px);
      transition: opacity 0.14s, transform 0.14s;
      overflow: hidden;
    }

    .kb-panel.open {
      opacity: 1;
      pointer-events: all;
      transform: translateY(0);
    }

    .field-input.kb-active {
      border-color: var(--amber);
      box-shadow: 0 0 0 2px var(--amber-glow);
    }

    /* Header */
    .kb-header {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 7px 10px;
      border-bottom: 1px solid var(--border);
      background: #0f0e0c;
    }

    .kb-preview {
      font-family: var(--mono);
      font-size: clamp(14px, 4vw, 18px);
      color: var(--cream);
      flex: 1;
      letter-spacing: 1px;
    }

    .kb-preview-cursor::after {
      content: '|';
      color: var(--amber);
      animation: blink 1s step-end infinite;
    }

    @keyframes blink {
      50% {
        opacity: 0;
      }
    }

    .kb-done {
      background: var(--amber);
      color: var(--bg);
      border: none;
      font-family: var(--display);
      font-size: 15px;
      letter-spacing: 2px;
      padding: 5px 14px;
      cursor: pointer;
      flex-shrink: 0;
      -webkit-tap-highlight-color: transparent;
    }

    /* Two-column numpad body */
    .kb-body {
      display: grid;
      grid-template-columns: 1fr 1fr;
    }

    /* No-feet mode: hide feet column, expand inches to fill */
    .kb-panel.kb-no-feet .kb-body {
      grid-template-columns: 1fr;
    }

    .kb-panel.kb-no-feet .kb-col:first-child {
      display: none;
    }

    .kb-col {
      padding: 7px 7px 4px;
    }

    .kb-col:first-child {
      border-right: 1px solid var(--border);
    }

    .kb-numpad {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 4px;
    }

    .kb-col-label {
      font-size: 9px;
      letter-spacing: 3px;
      text-transform: uppercase;
      text-align: center;
      padding: 4px 0 2px;
      font-family: var(--mono);
    }

    .kb-col-label.feet-label {
      color: #7aaad4;
    }

    .kb-col-label.inches-label {
      color: #7ab87a;
    }

    /* Base button */
    .kb-btn {
      background: var(--card);
      border: 1px solid var(--border);
      color: var(--cream);
      font-family: var(--mono);
      font-size: clamp(13px, 3.8vw, 18px);
      font-weight: 700;
      height: clamp(34px, 9.5vw, 46px);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      -webkit-tap-highlight-color: transparent;
      transition: background 0.08s;
      user-select: none;
      -webkit-user-select: none;
      border-radius: 0;
    }

    .kb-btn:active {
      background: var(--border);
    }

    /* Feet — blue tint */
    .kb-btn.kb-feet-btn {
      background: #14202e;
      border-color: #25395a;
      color: #9bbfe0;
    }

    .kb-btn.kb-feet-btn:active {
      background: #25395a;
    }

    /* Inches — green tint */
    .kb-btn.kb-inch-btn {
      background: #142014;
      border-color: #254028;
      color: #88cc88;
    }

    .kb-btn.kb-inch-btn:active {
      background: #254028;
    }

    /* Del / Clear */
    .kb-btn.kb-del {
      background: #221414;
      border-color: #402020;
      color: #c07070;
      font-size: 16px;
    }

    .kb-btn.kb-del:active {
      background: #402020;
    }

    .kb-btn.kb-clear {
      background: #1e1a10;
      border-color: #3a3010;
      color: var(--amber);
      font-size: 11px;
      letter-spacing: 1px;
    }

    /* Fractions section */
    .kb-fracs-section {
      border-top: 1px solid var(--border);
      padding: 6px 7px 7px;
    }

    .kb-fracs-label {
      font-size: 8px;
      letter-spacing: 3px;
      color: var(--muted);
      text-transform: uppercase;
      margin-bottom: 5px;
      text-align: center;
    }

    .kb-fracs-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 4px;
    }

    .kb-btn.kb-frac {
      font-size: clamp(10px, 2.8vw, 13px);
      font-weight: 400;
      height: clamp(28px, 7.5vw, 38px);
    }

    .kb-btn.kb-frac.kb-frac-8 {
      color: #c8d4ff;
      border-color: #3a3d5a;
      background: #181a28;
    }

    .kb-btn.kb-frac.kb-frac-16 {
      color: #d0d8ff;
      border-color: #30324a;
      background: #141520;
    }

    .kb-btn.kb-frac.kb-selected {
      outline: 2px solid var(--amber);
      outline-offset: -2px;
      color: var(--amber);
    }
  </style>
</head>

<body>
  <div class="page">

    <header class="header">
      <span class="header-eyebrow">Carpentry Tool</span>
      <h1 class="header-title">Spacer<br>Calculator</h1>
      <p class="header-sub">Even spacing &bull; Imperial fractions</p>
    </header>

    <form id="spacerForm" onsubmit="return false;">
      <div class="field-group">

        <div class="field">
          <label class="field-label" for="totalLength">Total Length</label>
          <input class="field-input kb-target" type="text" id="totalLength" placeholder='e.g. 48 1/2' autocomplete="off"
            autocorrect="off" spellcheck="false" inputmode="none">
        </div>

        <div class="field">
          <label class="field-label" for="spacerWidth">Spacer Width</label>
          <input class="field-input kb-target" type="text" id="spacerWidth" placeholder='e.g. 1 3/8' autocomplete="off"
            autocorrect="off" spellcheck="false" inputmode="none" data-no-feet="true">
        </div>

        <div class="field">
          <label class="field-label">Number of Spacers</label>
          <div class="counter-row">
            <button type="button" class="counter-btn" id="decrementSpacers">&#x2212;</button>
            <input class="counter-val" type="number" id="numSpacers" min="1" value="1">
            <button type="button" class="counter-btn" id="incrementSpacers">&#x2B;</button>
          </div>
        </div>

      </div>

      <div class="toggle-field">
        <div>
          <div class="toggle-label-text">Spacers at ends</div>
          <div class="toggle-desc">Include spacer at each end</div>
        </div>
        <label class="switch">
          <input type="checkbox" id="endsToggle">
          <span class="slider"></span>
        </label>
      </div>

      <div class="field" style="margin-top:16px;">
        <label class="field-label" for="rounding">Rounding Precision</label>
        <select class="field-select" id="rounding">
          <option value="16">Nearest 1/16"</option>
          <option value="8">Nearest 1/8"</option>
        </select>
      </div>

      <button type="button" class="calc-btn" onclick="calculateAndShow()">CALCULATE</button>
    </form>

    <!-- Results (hidden until calculated) -->
    <div id="resultSection" class="result-hidden">
      <div class="divider"></div>

      <div id="errorBox" class="error-box result-hidden"></div>

      <div id="successContent" class="result-hidden">
        <div class="result-highlight">
          <div class="result-highlight-label">Each Space</div>
          <div class="result-highlight-value" id="mainResult">—</div>
        </div>

        <div class="result-grid">
          <div class="result-tile">
            <div class="result-tile-label">Total Length</div>
            <div class="result-tile-value" id="r-total">—</div>
          </div>
          <div class="result-tile">
            <div class="result-tile-label">Spacer Width</div>
            <div class="result-tile-value" id="r-width">—</div>
          </div>
          <div class="result-tile">
            <div class="result-tile-label">Spacers (total)</div>
            <div class="result-tile-value" id="r-count">—</div>
          </div>
          <div class="result-tile">
            <div class="result-tile-label">End Spacers</div>
            <div class="result-tile-value" id="r-ends">—</div>
          </div>
        </div>

        <div class="viz-section">
          <div class="viz-label">Layout Preview</div>
          <div class="viz-track" id="vizTrack"></div>
        </div>

        <div class="table-section">
          <div class="table-label">Spacer Positions</div>
          <div id="spacerTable"></div>
        </div>
      </div>
    </div>

  </div>

  <script>
    /* ── Parse "48 1/2" → decimal ── */
    function parseInches(str) {
      str = (str || '').trim();
      if (!str) return 0;
      let inches = 0;
      // Handle feet notation: e.g. "4' 8 1/2" or "4'8 1/2"
      if (str.includes("'")) {
        const feetSplit = str.split("'");
        inches += parseInt(feetSplit[0], 10) * 12;
        str = feetSplit[1].trim();
        if (!str) return isNaN(inches) ? 0 : inches;
      }
      // Now parse remaining as plain inches + fraction
      const parts = str.split(' ');
      if (parts.length === 2) {
        inches += parseInt(parts[0], 10);
        const frac = parts[1].split('/');
        if (frac.length === 2) inches += parseInt(frac[0], 10) / parseInt(frac[1], 10);
      } else if (parts.length === 1) {
        if (parts[0].includes('/')) {
          const frac = parts[0].split('/');
          if (frac.length === 2) inches += parseInt(frac[0], 10) / parseInt(frac[1], 10);
        } else {
          inches += parseFloat(parts[0]);
        }
      }
      return isNaN(inches) ? 0 : inches;
    }

    function gcd(a, b) { while (b) { [a, b] = [b, a % b]; } return a; }

    /* ── Decimal → "x y/z" ── */
    function formatInches(val, denom) {
      let whole = Math.floor(val);
      let frac = val - whole;
      let num = Math.round(frac * denom);
      if (num === denom) { whole += 1; num = 0; }
      if (num === 0) return `${whole}"`;
      const d = gcd(num, denom);
      const sn = num / d, sd = denom / d;
      return whole === 0 ? `${sn}/${sd}"` : `${whole} ${sn}/${sd}"`;
    }

    function calculateAndShow() {
      const totalLength = parseInches(document.getElementById('totalLength').value);
      const spacerWidth = parseInches(document.getElementById('spacerWidth').value);
      const numSpacers = Math.max(1, parseInt(document.getElementById('numSpacers').value, 10) || 1);
      const ends = document.getElementById('endsToggle').checked;
      const rounding = parseInt(document.getElementById('rounding').value, 10);

      const resultSection = document.getElementById('resultSection');
      const errorBox = document.getElementById('errorBox');
      const successContent = document.getElementById('successContent');

      resultSection.classList.remove('result-hidden');
      errorBox.classList.add('result-hidden');
      successContent.classList.add('result-hidden');

      function showError(msg) {
        errorBox.textContent = msg;
        errorBox.classList.remove('result-hidden');
      }

      if (totalLength <= 0) return showError('Enter a valid total length.');
      if (spacerWidth < 0) return showError('Spacer width cannot be negative.');

      const actualSpacers = ends ? numSpacers + 2 : numSpacers;
      const numSpaces = numSpacers + 1;
      const totalSpacersWidth = actualSpacers * spacerWidth;

      if (totalSpacersWidth >= totalLength) {
        return showError(`Spacers too wide for this length. Max spacer width: ${formatInches((totalLength) / actualSpacers, rounding)}`);
      }

      const space = (totalLength - totalSpacersWidth) / numSpaces;

      // Populate result tiles
      document.getElementById('mainResult').textContent = formatInches(space, rounding);
      document.getElementById('r-total').textContent = formatInches(totalLength, rounding);
      document.getElementById('r-width').textContent = formatInches(spacerWidth, rounding);
      document.getElementById('r-count').textContent = actualSpacers;
      document.getElementById('r-ends').textContent = ends ? 'Yes' : 'No';

      successContent.classList.remove('result-hidden');

      // ── Visualization ──
      const track = document.getElementById('vizTrack');
      track.innerHTML = '';
      const total = totalLength;
      const sequence = buildSequence(actualSpacers, numSpaces, ends);

      sequence.forEach(item => {
        const el = document.createElement('div');
        const w = ((item.type === 'spacer' ? spacerWidth : space) / total) * 100;
        el.style.flex = `0 0 ${w}%`;
        el.className = item.type === 'spacer' ? 'viz-spacer' : 'viz-space';
        track.appendChild(el);
      });

      // ── Table ──
      let pos = 0;
      let tableHtml = '<table><thead><tr><th>#</th><th>Start</th><th>Center</th><th>End</th></tr></thead><tbody>';
      let spacerIdx = 1;
      sequence.forEach(item => {
        if (item.type === 'spacer') {
          const start = pos;
          const center = pos + spacerWidth / 2;
          const end = pos + spacerWidth;
          tableHtml += `<tr>
          <td>${spacerIdx++}</td>
          <td>${formatInches(start, rounding)}</td>
          <td>${formatInches(center, rounding)}</td>
          <td>${formatInches(end, rounding)}</td>
        </tr>`;
          pos += spacerWidth;
        } else {
          pos += space;
        }
      });
      tableHtml += '</tbody></table>';
      document.getElementById('spacerTable').innerHTML = tableHtml;
    }

    function buildSequence(actualSpacers, numSpaces, ends) {
      const total = actualSpacers + numSpaces;
      const seq = [];
      for (let i = 0; i < total; i++) {
        if (ends) {
          seq.push({ type: i % 2 === 0 ? 'spacer' : 'space' });
        } else {
          seq.push({ type: i % 2 === 0 ? 'space' : 'spacer' });
        }
      }
      return seq;
    }

    // Wire up controls
    document.getElementById('incrementSpacers').addEventListener('click', function () {
      const inp = document.getElementById('numSpacers');
      inp.value = Math.max(1, parseInt(inp.value, 10) + 1);
      calculateAndShow();
    });
    document.getElementById('decrementSpacers').addEventListener('click', function () {
      const inp = document.getElementById('numSpacers');
      inp.value = Math.max(1, parseInt(inp.value, 10) - 1);
      calculateAndShow();
    });

    document.getElementById('endsToggle').addEventListener('change', calculateAndShow);
    document.getElementById('rounding').addEventListener('change', calculateAndShow);
    document.getElementById('numSpacers').addEventListener('input', calculateAndShow);
  </script>

  <!-- Custom imperial keyboard -->
  <div class="kb-overlay" id="kbOverlay"></div>
  <div class="kb-panel" id="kbPanel">
    <div class="kb-header">
      <span class="kb-preview kb-preview-cursor" id="kbPreview">—</span>
      <button class="kb-done" id="kbDone">DONE</button>
    </div>
    <div class="kb-body">
      <!-- FEET column -->
      <div class="kb-col">
        <div class="kb-numpad">
          <button class="kb-btn kb-feet-btn" data-action="feet" data-val="1">1</button>
          <button class="kb-btn kb-feet-btn" data-action="feet" data-val="2">2</button>
          <button class="kb-btn kb-feet-btn" data-action="feet" data-val="3">3</button>
          <button class="kb-btn kb-feet-btn" data-action="feet" data-val="4">4</button>
          <button class="kb-btn kb-feet-btn" data-action="feet" data-val="5">5</button>
          <button class="kb-btn kb-feet-btn" data-action="feet" data-val="6">6</button>
          <button class="kb-btn kb-feet-btn" data-action="feet" data-val="7">7</button>
          <button class="kb-btn kb-feet-btn" data-action="feet" data-val="8">8</button>
          <button class="kb-btn kb-feet-btn" data-action="feet" data-val="9">9</button>
          <button class="kb-btn kb-feet-btn" data-action="feet" data-val="0">0</button>
          <button class="kb-btn kb-del" data-action="del-feet">⌫</button>
          <button class="kb-btn kb-clear" data-action="clr-feet">CLR</button>
        </div>
        <div class="kb-col-label feet-label">Feet</div>
      </div>
      <!-- INCHES column -->
      <div class="kb-col">
        <div class="kb-numpad">
          <button class="kb-btn kb-inch-btn" data-action="inch" data-val="1">1</button>
          <button class="kb-btn kb-inch-btn" data-action="inch" data-val="2">2</button>
          <button class="kb-btn kb-inch-btn" data-action="inch" data-val="3">3</button>
          <button class="kb-btn kb-inch-btn" data-action="inch" data-val="4">4</button>
          <button class="kb-btn kb-inch-btn" data-action="inch" data-val="5">5</button>
          <button class="kb-btn kb-inch-btn" data-action="inch" data-val="6">6</button>
          <button class="kb-btn kb-inch-btn" data-action="inch" data-val="7">7</button>
          <button class="kb-btn kb-inch-btn" data-action="inch" data-val="8">8</button>
          <button class="kb-btn kb-inch-btn" data-action="inch" data-val="9">9</button>
          <button class="kb-btn kb-inch-btn" data-action="inch" data-val="0">0</button>
          <button class="kb-btn kb-del" data-action="del-inch">⌫</button>
          <button class="kb-btn kb-clear" data-action="clr-inch">CLR</button>
        </div>
        <div class="kb-col-label inches-label">Inches</div>
      </div>
    </div>
    <!-- Fractions below both columns -->
    <div class="kb-fracs-section">
      <div class="kb-fracs-label">Fraction</div>
      <div class="kb-fracs-grid">
        <button class="kb-btn kb-frac kb-frac-16" data-action="frac" data-val="1/16">1/16</button>
        <button class="kb-btn kb-frac kb-frac-8" data-action="frac" data-val="1/8">1/8</button>
        <button class="kb-btn kb-frac kb-frac-16" data-action="frac" data-val="3/16">3/16</button>
        <button class="kb-btn kb-frac kb-frac-8" data-action="frac" data-val="1/4">1/4</button>
        <button class="kb-btn kb-frac kb-frac-16" data-action="frac" data-val="5/16">5/16</button>
        <button class="kb-btn kb-frac kb-frac-8" data-action="frac" data-val="3/8">3/8</button>
        <button class="kb-btn kb-frac kb-frac-16" data-action="frac" data-val="7/16">7/16</button>
        <button class="kb-btn kb-frac kb-frac-8" data-action="frac" data-val="1/2">1/2</button>
        <button class="kb-btn kb-frac kb-frac-16" data-action="frac" data-val="9/16">9/16</button>
        <button class="kb-btn kb-frac kb-frac-8" data-action="frac" data-val="5/8">5/8</button>
        <button class="kb-btn kb-frac kb-frac-16" data-action="frac" data-val="11/16">11/16</button>
        <button class="kb-btn kb-frac kb-frac-8" data-action="frac" data-val="3/4">3/4</button>
        <button class="kb-btn kb-frac kb-frac-16" data-action="frac" data-val="13/16">13/16</button>
        <button class="kb-btn kb-frac kb-frac-8" data-action="frac" data-val="7/8">7/8</button>
        <button class="kb-btn kb-frac kb-frac-16" data-action="frac" data-val="15/16">15/16</button>
        <button class="kb-btn kb-frac" data-action="frac" data-val="">—</button>
      </div>
    </div>
  </div>

  <script>
    /* ── Imperial keyboard ── */
    (function () {
      let activeInput = null;
      let kbFeet = '';
      let kbInches = '';
      let kbFrac = '';

      const panel = document.getElementById('kbPanel');
      const overlay = document.getElementById('kbOverlay');
      const preview = document.getElementById('kbPreview');

      function buildValue() {
        const parts = [];
        if (kbFeet !== '') parts.push(kbFeet + "'");
        if (kbInches !== '') parts.push(kbInches);
        if (kbFrac !== '') parts.push(kbFrac);
        return parts.join(' ');
      }

      function updatePreview() {
        const val = buildValue();
        preview.textContent = val === '' ? '—' : val + '"';
      }

      function commitToInput() {
        if (!activeInput) return;
        activeInput.value = buildValue();
        calculateAndShow();
      }

      function positionPanel(input) {
        const rect = input.getBoundingClientRect();
        panel.style.width = Math.round(rect.width) + 'px';
        panel.style.left = Math.round(rect.left) + 'px';
        panel.style.top = Math.round(rect.bottom) + 6 + 'px';
        panel.style.bottom = 'auto';
      }

      function openKeyboard(input) {
        if (activeInput === input && panel.classList.contains('open')) return;
        activeInput = input;
        kbFeet = ''; kbInches = ''; kbFrac = '';
        // Hide feet column for inputs that don't need it
        panel.classList.toggle('kb-no-feet', !!input.dataset.noFeet);
        let raw = input.value.trim();
        if (raw) {
          if (raw.includes("'")) {
            const s = raw.split("'");
            kbFeet = s[0].trim();
            raw = s[1].trim();
          }
          if (raw) {
            const parts = raw.split(' ');
            if (parts.length >= 2) { kbInches = parts[0]; kbFrac = parts[1]; }
            else if (parts[0].includes('/')) { kbFrac = parts[0]; }
            else { kbInches = parts[0]; }
          }
        }
        syncFracHighlight();
        updatePreview();
        positionPanel(input);
        panel.classList.add('open');
        overlay.classList.add('open');
        input.classList.add('kb-active');
      }

      function closeKeyboard() {
        panel.classList.remove('open');
        overlay.classList.remove('open');
        if (activeInput) {
          activeInput.classList.remove('kb-active');
          activeInput.blur();
        }
        activeInput = null;
      }

      function syncFracHighlight() {
        document.querySelectorAll('.kb-btn.kb-frac').forEach(b => {
          b.classList.toggle('kb-selected', b.dataset.val === kbFrac && kbFrac !== '');
        });
      }

      // Wire inputs
      document.querySelectorAll('.kb-target').forEach(input => {
        input.addEventListener('focus', () => openKeyboard(input));
        input.addEventListener('click', () => openKeyboard(input));
        input.addEventListener('keydown', e => e.preventDefault());
      });

      overlay.addEventListener('click', () => { commitToInput(); closeKeyboard(); });
      document.getElementById('kbDone').addEventListener('click', () => { commitToInput(); closeKeyboard(); });

      // Reposition on scroll/resize
      window.addEventListener('scroll', () => { if (activeInput) positionPanel(activeInput); }, { passive: true });
      window.addEventListener('resize', () => { if (activeInput) positionPanel(activeInput); }, { passive: true });

      panel.addEventListener('click', function (e) {
        const btn = e.target.closest('[data-action]');
        if (!btn) return;
        const action = btn.dataset.action;
        const val = btn.dataset.val;

        if (action === 'feet') {
          if (kbFeet.length < 2) kbFeet = (kbFeet + val).replace(/^0+(\d)/, '$1');
        } else if (action === 'inch') {
          if (kbInches.length < 2) kbInches = (kbInches + val).replace(/^0+(\d)/, '$1');
        } else if (action === 'frac') {
          kbFrac = val; // empty string = clear fraction (— button)
        } else if (action === 'del-feet') {
          kbFeet = kbFeet.slice(0, -1);
        } else if (action === 'clr-feet') {
          kbFeet = '';
        } else if (action === 'del-inch') {
          if (kbInches.length > 0) kbInches = kbInches.slice(0, -1);
          else kbFrac = '';
        } else if (action === 'clr-inch') {
          kbInches = '';
          kbFrac = '';
        }

        syncFracHighlight();
        updatePreview();
        commitToInput();
      });
    })();
  </script>

  <script>
    /* ── PWA: register service worker ── */
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('./sw.js', { scope: './' })
        .catch(() => { }); // silently fail on file:// protocol
    }
  </script>
</body>

</html>